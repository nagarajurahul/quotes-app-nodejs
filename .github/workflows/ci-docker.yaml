name: ci-docker

on:
  push:
    branches: [main]
  pull_request:
    branches: [ main ]

env:
  environment: production

jobs:
  lint-and-scan:
    name: Lint and Scan the code
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: 24
        cache: 'npm'

    - name: Install dependencies
      run: npm ci
      # npm ci is better in production for faster, deterministic image building
      run: npm install

    - name: Run Lint
      run: npm run lint

    - name: Run Tests
      run: npm test

    - name: Security Audit
      run: npm run scan

  lint-dockerfile:
    name: Lint Dockerfile
    runs-on: ubuntu-24.04
    
    steps:

      # Checkout repo
      - name: Checkout code
        uses: actions/checkout@v6

      # Lint Dockerfile
      - name: Dockerfile Lint
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: ./Dockerfile
          config: .hadolint.yaml
          failure-threshold: warning

  ci:
    name: CI - Build, Scan & Push Docker Image
    runs-on: ubuntu-24.04
    needs: lint-and-scan

    steps:

    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Qemu
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Set IMAGE_TAG
      id: vars
      run: echo "IMAGE_TAG=${{ env.environment }}-${GITHUB_SHA}" >> $GITHUB_OUTPUT

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build Docker image (no push yet)
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile
        push: false # only build, so that we can scan image using Trivy
        load: true # load image into runnerâ€™s Docker engine
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_IMAGE }}:${{ steps.vars.outputs.IMAGE_TAG }}
    
    # This is good, but requires credentials or secrets to be created as env variables inside github actions above

    # - name: Login to Docker Hub
    #   run: echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin

    # - name: Build Docker image (no push yet)
    #   env:
    #     IMAGE_TAG: ${{ steps.vars.outputs.IMAGE_TAG }}
    #   run: |
    #     docker build -t ${DOCKERHUB_USERNAME}/${DOCKERHUB_IMAGE}:${IMAGE_TAG} .

    - name: Run Trivy vulnerability scanner
      id: trivy
      uses: aquasecurity/trivy-action@0.33.1
      with:
        image-ref: '${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_IMAGE }}:${{ steps.vars.outputs.IMAGE_TAG }}'
        format: 'json'
        output: 'trivy-results.json'
        severity: 'CRITICAL,HIGH'
        ignore-unfixed: true
        vuln-type: 'os,library'
        scanners: vuln
        exit-code: '1'

      continue-on-error: false

    - name: Push Docker image (only if scan passed)
      if: steps.trivy.outcome == 'success'
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_IMAGE }}:${{ steps.vars.outputs.IMAGE_TAG }}

      # - name: ðŸš€ Push image to Docker Hub
      #   if: steps.trivy.outcome == 'success'
      #   env:
      #     IMAGE_TAG: ${{ steps.vars.outputs.IMAGE_TAG }}
      #   run: |
      #     docker push ${DOCKERHUB_USERNAME}/${DOCKERHUB_IMAGE}:${IMAGE_TAG